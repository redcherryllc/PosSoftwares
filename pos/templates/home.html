{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>POS System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'images/css/home.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="top-nav">
        <div class="sale-total" id="saleTotal">TOTAL: 0.00</div>
        <div class="store-name">{{ saas_customer.saas_customer_name }}</div>
        <button class="hamburger" onclick="toggleNav()">
            <i class="fas fa-bars"></i>
        </button>
        <button class="control-toggle" onclick="toggleControlPanel()">
            <i class="fas fa-th-list"></i>
        </button>
        <div class="nav-buttons">
            <div class="next-sale-badge">
                <i class="fas fa-receipt receipt-icon"></i>
                <span class="sale-number">{{ next_sale_no }}</span>
            </div>
            <div class="debug-sale-no" style="display: none;">Debug next_sale_no: {{ next_sale_no }}</div>
            <button class="nav-button save" onclick="saveSale()">üíæ Save</button>
            <button class="nav-button print" onclick="printSale()">üñ® Print</button>
            <button class="nav-button pay" onclick="initiatePayment()">üí≥ Pay</button>
            <a href="{% url 'view_order' %}"><button class="nav-button view">üßæ View</button></a>
            <select class="nav-button dropdown" name="table_select">
                <option value="" disabled selected>üçΩ Table</option>
                {% for table in tables %}
                    <option value="{{ table.table_id }}">{{ table.location }} ({{ table.no_of_seats }})</option>
                {% empty %}
                    <option disabled>No Tables</option>
                {% endfor %}
            </select>

            <select class="nav-button dropdown" name="room_select" id="room_select">
    <option value="" disabled {% if not selected_room_id %}selected{% endif %}>üè® Room</option>
    {% for room in rooms %}
        <option value="{{ room.room_id }}"
                {% if selected_room_id == room.room_id %}selected{% endif %}>
            {{ room.room_name }} ({{ room.location }})
        </option>
    {% empty %}
        <option disabled>No Rooms</option>
    {% endfor %}
</select>

            <button class="nav-button all" onclick="filterItems('all')">Menu List</button>
            <select class="nav-button dropdown" name="vehicle_select">
                <option value="" disabled selected>üöó Vehicle</option>
                {% for vehicle in vehicles %}
                    <option value="{{ vehicle.vehicle_id }}">{{ vehicle.vehicle_type }} ({{ vehicle.vehicle_name }})</option>
                {% empty %}
                    <option disabled>No Vehicles</option>
                {% endfor %}
            </select>
            <select class="nav-button dropdown" name="customer_select">
                <option value="" disabled {% if not customers %}selected{% endif %}>üë§ Customer</option>
                {% for customer in customers %}
                    <option value="{{ customer.customer_id }}"
                            {% if customer.customer_name == "Walking Customer" %}selected{% endif %}>
                        {{ customer.customer_name }}
                    </option>
                {% empty %}
                    <option disabled>No Customers</option>
                {% endfor %}
            </select>
            <button class="nav-button set-customer" data-bs-toggle="modal" data-bs-target="#customerModal">
                üë§+ New
            </button>
            <button class="nav-button register" data-bs-toggle="modal" data-bs-target="#customerModal">
                üìù Register
            </button>
        </div>
    </div>
    
    <div class="overlay"></div>
    <div class="container">
        <div class="sales-panel">
            <div class="sales-items">
                <table id="salesTable">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Qty</th>
                            <th>Price</th>
                            <th>Disc</th>
                            <th>Tax</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="salesTableBody"></tbody>
                </table>
            </div>
            <div class="keypad">
                <button class="nav-button mult">MULT</button>
                <button class="nav-button plus" onclick="incrementItem()">++</button>
                <button class="nav-button minus" onclick="decrementItem()">--</button>
                <button onclick="addToKeypad('7')">7</button>
                <button onclick="addToKeypad('8')">8</button>
                <button onclick="addToKeypad('9')">9</button>
                <button onclick="addToKeypad('4')">4</button>
                <button onclick="addToKeypad('5')">5</button>
                <button onclick="addToKeypad('6')">6</button>
                <button onclick="addToKeypad('1')">1</button>
                <button onclick="addToKeypad('2')">2</button>
                <button onclick="addToKeypad('3')">3</button>
                <button onclick="addToKeypad('0')">0</button>
                <button onclick="clearSale()">CLR</button>
                <button onclick="completeSale()">OK</button>
            </div>
        </div>
        <div class="pos-grid">
            <div class="pos-grid-label">PRODUCT OR MENU LIST</div>
            <div class="pos-items" id="posGrid">
                {% if products %}
                    {% for product in products %}
                        <div class="pos-item" onclick="addItemToSale('{{ product.product_id }}', '{{ product.product_name|escapejs }}', {{ product.sale_price }})">
                            {% if product.product_image %}
                                <img src="{{ product.product_image.url }}" alt="{{ product.product_name|escape }}" loading="lazy">
                            {% else %}
                                <div class="no-image-placeholder"></div>
                            {% endif %}
                            <p>{{ product.product_name }}</p>
                            <p>Cost: {{ product.sale_price }}</p>
                        </div>
                    {% endfor %}
                {% else %}
                    <p>No products available.</p>
                {% endif %}
            </div>
        </div>
        <div class="control-panel">
            <div class="button-group">
                {% for group in product_groups %}
                    <button class="control-button" onclick="filterItems('{{ group.product_group_id }}')">
                        {% if group.product_image %}
                            <img src="{{ group.product_image.url }}" alt="{{ group.product_name|escape }}" style="max-width: 50px; height: auto;">
                        {% else %}
                            <div class="no-image-placeholder"></div>
                        {% endif %}
                        <br>
                        {{ group.product_name }}
                    </button>
                {% empty %}
                    <p>No product groups available.</p>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerModalLabel">Customer and Registration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="customer-search-section">
                        <div class="input-group mb-3">
                            <input type="text" id="customer-search-input" class="form-control" placeholder="Search by name, phone, or Aadhaar">
                            <button id="customer-search-btn" class="btn btn-primary">Search</button>
                        </div>
                        <div id="customer-search-results" class="mb-3"></div>
                    </div>
                    <div id="customer-form-section" style="display: none;">
                        <h6>Add New Customer</h6>
                        <form id="customer-form" method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="customer_submit" value="1">
                            {{ customer_form.as_p }}
                            <button type="submit" class="btn btn-primary">Save Customer</button>
                            <button type="button" id="show-registration-form-btn" class="btn btn-secondary" style="display: none;">Proceed to Registration</button>
                        </form>
                    </div>
                    <div id="registration-form-section" style="display: none;">
                        <h6>Add Registration</h6>
                        <form id="registration-form" method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="registration_submit" value="1">
                            {{ registration_form.as_p }}
                            <button type="submit" class="btn btn-primary">Save Registration</button>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="overlay"></div>
    <div class="bottom-bar">
        <div id="nonTax">NON-TAX: 0.00</div>
        <div id="taxTotal">TAX: 0.00</div>
        <div id="subtotal">SUBTOTAL: 0.00</div>
        <div id="discountTotal">DISCOUNT: 0.00</div>
        <div>Business Unit Group: {{ business_unit_group.business_unit_group_name }}</div>
        <div>Business Unit: {{ business_unit.business_unit_name }}</div>
        <div>Branch: {{ branch.branch_name }}</div>
        <div class="login-user">Login User: {{ username }}!</div>
        <div class="time" id="currentTime"></div>
        <div class="logout"><a href="{% url 'logout' %}">Logout</a></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="{% static 'images/js/home.js' %}"></script>

    <script>
    window.registrationAddUrl = '{% url "registration_add" %}';
    window.addCustomerUrl = '{% url "add_customer" %}';
    window.getCustomersUrl = '/api/customers/';
    window.nextSaleNo = '{{ next_sale_no }}';
    window.selectedRoomId = '{{ selected_room_id|default:"" }}'.trim();
    window.homeUrl = '{% url "home" %}';
    
    
    console.log('Template Variables:', {
        selectedRoomId: window.selectedRoomId,
        nextSaleNo: window.nextSaleNo,
        homeUrl: window.homeUrl
    });

    
    document.addEventListener('DOMContentLoaded', function() {
        const roomSelect = document.querySelector('select[name="room_select"]');
        const selectedRoomIdFromTemplate = window.selectedRoomId ? window.selectedRoomId.trim() : '';
        
        console.log('Selected room ID from template:', selectedRoomIdFromTemplate);
        
        if (selectedRoomIdFromTemplate) {
            const matchingOption = roomSelect.querySelector(`option[value="${selectedRoomIdFromTemplate}"]`);
            if (matchingOption) {
                roomSelect.value = selectedRoomIdFromTemplate;
                window.currentServiceType = 'ROOM';
                window.currentServiceId = selectedRoomIdFromTemplate;
                console.log('Room selected:', roomSelect.selectedOptions[0].text);

                
                fetch(window.homeUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ room_id: selectedRoomIdFromTemplate })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    console.log('Room selection updated in session:', selectedRoomIdFromTemplate);
                })
                .catch(error => {
                    console.error('Error updating room selection:', error);
                    alert('Error updating room selection. Please try again.');
                });
            } else {
                console.warn('Room option not found in dropdown:', selectedRoomIdFromTemplate);
                roomSelect.value = '';
                window.currentServiceType = '';
                window.currentServiceId = 0;
            }
        } else {
            console.log('No selected room ID, resetting room_select');
            roomSelect.value = '';
            window.currentServiceType = '';
            window.currentServiceId = 0;
        }

        
        roomSelect.addEventListener('change', function() {
            const selectedValue = this.value;
            window.currentServiceType = selectedValue ? 'ROOM' : '';
            window.currentServiceId = selectedValue || 0;

            if (selectedValue) {
                
                document.querySelector('select[name="table_select"]').value = '';
                document.querySelector('select[name="vehicle_select"]').value = '';
                
                console.log('Room selected, updating session with room_id:', selectedValue);
                
                fetch(window.homeUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ room_id: selectedValue })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    console.log('Room selection updated in session:', selectedValue);
                })
                .catch(error => {
                    console.error('Error updating room selection:', error);
                    alert('Error updating room selection. Please try again.');
                });
            } else {
                console.log('Room deselected, clearing session');
                fetch(window.homeUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ clear_room: '1' })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    console.log('Cleared room selection from session');
                })
                .catch(error => {
                    console.error('Error clearing room selection:', error);
                });
            }
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

</body>
</html>